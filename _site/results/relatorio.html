<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Wenderson Santos">

<title>Análise Estatística de Fatores de Risco para Doença Coronária</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-883fcb54665cb35c022f5a38a2a72681.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Análise Estatística de Fatores de Risco para Doença Coronária</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Wenderson Santos </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introdução" class="level1">
<h1>Introdução</h1>
<p>O dataset provém de um estudo que analisou 297 pacientes na Cleveland Clinic para avaliação da Doença Coronária;</p>
<p>O experimento envolveu 3 estágios:</p>
<ul>
<li>Teste de esforço (protocolo de Bruce)</li>
<li>Cinefluoroscopia</li>
<li>Angiografia coronária</li>
<li>Cintilografia com Tálio-201</li>
</ul>
<section id="variáveis-analisadas" class="level2">
<h2 class="anchored" data-anchor-id="variáveis-analisadas">Variáveis analisadas</h2>
<ul>
<li><p>age</p></li>
<li><p>sex</p></li>
<li><p>cp : tipo de dor no peito</p>
<ul>
<li><p>Angina Típica: Atende a três critérios (localização atrás do osso do peito, provocada por esforço/estresse e aliviada por repouso).</p></li>
<li><p>Angina Atípica: Atende a apenas dois desses critérios.</p></li>
<li><p>Dor Não Anginosa: Atende a apenas um ou nenhum dos critérios, sugerindo que a causa pode ser muscular ou gástrica (não cardíaca).</p></li>
<li><p>Assintomático: O paciente não sente dor, mas o médico ainda assim solicitou os exames devido a outros fatores de risco (como idade ou histórico familiar).</p></li>
</ul></li>
<li><p>thalach : Frequência cardíaca máxima atingida antes da exaustão ou sintomas (no teste de esforço).</p></li>
<li><p>exang : Indica se o paciente sentiu angina (dor) durante o exercício.</p></li>
<li><p>oldpeak : diferença entre a posição do segmento ST (ECG) no repouso e no pico do esforço (thalac) (quanto maior essa diferença, maior é a área do coração que sofre por falta de sangue)</p></li>
<li><p>slope : Enquanto o oldpeak diz o quanto a linha afundou, o slope diz como ela se comporta logo após o afundamento. Existem três tipos principais de inclinação:</p>
<ul>
<li><p>Value 0: Upsloping (Ascendente): A linha afunda, mas sobe rápido. É comum em exercícios intensos e nem sempre indica doença grave.</p></li>
<li><p>Value 1: Flat (Plano): A linha afunda e fica “reta”. É um sinal clássico e preocupante de isquemia.</p></li>
<li><p>Value 2: Downsloping (Descendente): A linha afunda e continua descendo. É o sinal mais grave de todos, indicando que o coração está em alto sofrimento isquêmico. (mesmo após a interrupção do esforço)</p></li>
</ul></li>
<li><p>ca : Número de vasos principais com depósitos de cálcio ou interrupções no fluxo.</p>
<ul>
<li><p>0: Nenhuma calcificação significativa (indício de artérias limpas)</p></li>
<li><p>1, 2 o u 3: Indica que a doença está presente em um, dois ou três vasos principais.</p></li>
</ul></li>
<li><p>thal : Avalia se o sangue está chegando a todas as partes do coração durante o repouso e após o esforço.</p>
<ul>
<li><p>0 = Normal: O contraste se distribui uniformemente por todo o coração.</p></li>
<li><p>1 = Fixed Defect (Defeito Fixo): Uma parte do coração não recebe o contraste nem no esforço, nem no repouso. Isso geralmente indica tecido morto (cicatriz de um infarto antigo).</p></li>
<li><p>2 = Reversable Defect (Defeito Reversível): O coração parece normal em repouso, mas “falta sangue” em alguma região durante o esforço. Isso é o sinal clássico de isquemia ativa: a artéria está entupida, mas o tecido ainda está vivo e sofrendo.</p></li>
</ul></li>
<li><p>condition (target)</p></li>
<li><p>trestbps : É a pressão arterial medida no momento da internação.</p></li>
<li><p>fbs : Glicemia de Jejum é maior ou menor que 120mg/dl (binário)</p></li>
<li><p>chol : nível total de colesterol no sangue.</p></li>
<li><p>restecg :</p>
<ul>
<li><p>Value 0 (Normal): O coração em repouso não apresenta irregularidades elétricas.</p></li>
<li><p>Value 1 (Anormalidade de Onda ST-T): O coração já mostra sinais de sofrimento mesmo sem fazer esforço. É um sinal de alerta precoce.</p></li>
<li><p>Value 2 (Hipertrofia Ventricular Esquerda): Indica que o músculo do coração está “inchado” (grosso), geralmente por ter que fazer muita força para bombear o sangue contra uma pressão alta crônica.</p></li>
</ul></li>
</ul>
</section>
</section>
<section id="modelagem-com-regressão-logística" class="level1">
<h1>Modelagem com Regressão Logística</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"R"</span>, <span class="st">"modelPrep.R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="modelo-com-todas-as-variáveis" class="level2">
<h2 class="anchored" data-anchor-id="modelo-com-todas-as-variáveis">Modelo com todas as variáveis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>formula1 <span class="ot">&lt;-</span> condition <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> cp <span class="sc">+</span> thalach <span class="sc">+</span> exang <span class="sc">+</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                         oldpeak <span class="sc">+</span> slope <span class="sc">+</span> ca <span class="sc">+</span> thal <span class="sc">+</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                         trestbps <span class="sc">+</span> chol <span class="sc">+</span> fbs <span class="sc">+</span> restecg</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>modelo1_ <span class="ot">&lt;-</span> <span class="fu">glm</span>(formula1, <span class="at">data =</span> treino, <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo1_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = formula1, family = "binomial", data = treino)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -6.194972   3.665480  -1.690 0.091012 .  
age         -0.026817   0.029325  -0.914 0.360473    
sex1         1.751307   0.623152   2.810 0.004948 ** 
cp1          1.905287   0.923121   2.064 0.039021 *  
cp2          0.321896   0.847290   0.380 0.704011    
cp3          2.768984   0.864891   3.202 0.001367 ** 
thalach     -0.011517   0.012639  -0.911 0.362196    
exang1       0.337282   0.550815   0.612 0.540317    
oldpeak      0.649698   0.283217   2.294 0.021791 *  
slope1       1.341601   0.600799   2.233 0.025547 *  
slope2       0.402313   1.023407   0.393 0.694237    
ca1          2.575920   0.637209   4.043 5.29e-05 ***
ca2          3.119482   0.851992   3.661 0.000251 ***
ca3          2.982628   1.206518   2.472 0.013432 *  
thal1       -0.336710   0.979476  -0.344 0.731023    
thal2        1.486334   0.518928   2.864 0.004180 ** 
trestbps     0.014047   0.014133   0.994 0.320261    
chol         0.005760   0.005651   1.019 0.308039    
fbs1        -0.407723   0.701053  -0.582 0.560845    
restecg1     1.120803   3.359086   0.334 0.738634    
restecg2     0.261999   0.460966   0.568 0.569784    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 328.58  on 237  degrees of freedom
Residual deviance: 141.26  on 217  degrees of freedom
AIC: 183.26

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<p>O AIC foi de 183.26.</p>
<p>Embora o modelo explique bem a variável alvo, é possível observar que a maioria das covariáveis não é estatísticamente significativa, segundo o teste de Wald.</p>
<p>Para verificar isso, faremos um <strong>Teste de Razão de Verossimilhanças</strong>, verificando o impacto da retirada de cada variável.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pander</span>(<span class="fu">Anova</span>(modelo1_, <span class="at">type =</span> <span class="st">"III"</span>, <span class="at">test =</span> <span class="st">"LR"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Analysis of Deviance Table (Type III tests)</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 15%">
<col style="width: 6%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">LR Chisq</th>
<th style="text-align: center;">Df</th>
<th style="text-align: center;">Pr(&gt;Chisq)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>age</strong></td>
<td style="text-align: center;">0.8384</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.3599</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>sex</strong></td>
<td style="text-align: center;">8.776</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.003053</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>cp</strong></td>
<td style="text-align: center;">20.58</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0.0001287</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>thalach</strong></td>
<td style="text-align: center;">0.8493</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.3568</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>exang</strong></td>
<td style="text-align: center;">0.3705</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.5427</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>oldpeak</strong></td>
<td style="text-align: center;">5.789</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.01612</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>slope</strong></td>
<td style="text-align: center;">5.689</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.05818</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>ca</strong></td>
<td style="text-align: center;">30.8</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">9.375e-07</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>thal</strong></td>
<td style="text-align: center;">10.29</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.005832</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>trestbps</strong></td>
<td style="text-align: center;">0.9972</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.318</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>chol</strong></td>
<td style="text-align: center;">1.046</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.3065</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>fbs</strong></td>
<td style="text-align: center;">0.3411</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.5592</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>restecg</strong></td>
<td style="text-align: center;">0.4147</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.8127</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Aqui é possível obervar que as variáveis que mais contribuem para o modelo são: sex, cp, oldpeak, slope, ca e thal</p>
<p>Para verificar o impacto no modelo ao retirar essas variáveis, faremos o <strong>Teste de Razão de Verossimilhanças</strong> entre o modelo com todas as variáveis e o modelo sem as variáveis (age, thalach, exang, trestbps, chol, fbs, restecg)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo reduzido ( com 6 variáveis )</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>modelo_reduzido_ <span class="ot">&lt;-</span> <span class="fu">glm</span>(condition <span class="sc">~</span>  sex <span class="sc">+</span> cp <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                        oldpeak <span class="sc">+</span> slope <span class="sc">+</span> ca <span class="sc">+</span> thal,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> treino, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pander</span>(<span class="fu">anova</span>(modelo1_, modelo_reduzido_, <span class="at">test =</span> <span class="st">"Chisq"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Analysis of Deviance Table</caption>
<colgroup>
<col style="width: 16%">
<col style="width: 18%">
<col style="width: 6%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Resid. Df</th>
<th style="text-align: center;">Resid. Dev</th>
<th style="text-align: center;">Df</th>
<th style="text-align: center;">Deviance</th>
<th style="text-align: center;">Pr(&gt;Chi)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">217</td>
<td style="text-align: center;">141.3</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">NA</td>
</tr>
<tr class="even">
<td style="text-align: center;">225</td>
<td style="text-align: center;">146</td>
<td style="text-align: center;">-8</td>
<td style="text-align: center;">-4.728</td>
<td style="text-align: center;">0.7863</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>O P-valor foi de 0.7863, ou seja, não há evidências de que o modelo com todas as variáveis seja melhor que o modelo reduzido. Então optamos pelo uso do modelo reduzido.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pander</span>(<span class="fu">Anova</span>(modelo_reduzido_, <span class="at">type =</span> <span class="st">"III"</span>, <span class="at">test =</span> <span class="st">"LR"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Analysis of Deviance Table (Type III tests)</caption>
<colgroup>
<col style="width: 19%">
<col style="width: 15%">
<col style="width: 6%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">LR Chisq</th>
<th style="text-align: center;">Df</th>
<th style="text-align: center;">Pr(&gt;Chisq)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>sex</strong></td>
<td style="text-align: center;">7.552</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.005995</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>cp</strong></td>
<td style="text-align: center;">33.87</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2.114e-07</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>oldpeak</strong></td>
<td style="text-align: center;">8.84</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.002947</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>slope</strong></td>
<td style="text-align: center;">7.529</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.02318</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>ca</strong></td>
<td style="text-align: center;">36.4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">6.159e-08</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>thal</strong></td>
<td style="text-align: center;">13.53</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0.001152</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Todas variáveis contribuem significativamente para o modelo.</p>
</section>
<section id="analisando-a-linearidade-dosn-logits-em-relação-às-variáveis-contínuas-descartadas-pelo-teste-de-razão-de-verossimilhanças" class="level2">
<h2 class="anchored" data-anchor-id="analisando-a-linearidade-dosn-logits-em-relação-às-variáveis-contínuas-descartadas-pelo-teste-de-razão-de-verossimilhanças">Analisando a linearidade dosn logits em relação às variáveis contínuas descartadas pelo teste de razão de verossimilhanças</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_logit_linearity</span>(modelo1_, <span class="st">"age"</span>, treino)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
ℹ Please use tidy evaluation idioms with `aes()`.
ℹ See also `vignette("ggplot2-in-packages")` for more information.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="relatorio_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_logit_linearity</span>(modelo1_, <span class="st">"thalach"</span>, treino)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="relatorio_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_logit_linearity</span>(modelo1_, <span class="st">"trestbps"</span>, treino)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="relatorio_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_logit_linearity</span>(modelo1_, <span class="st">"chol"</span>, treino)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="relatorio_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>É possível observar que o logit varia drasticamente para o mesmo valor das variáveis age, trestbps e chol, indicando que elas não explicam bem a variável alvo.</p>
<p>Entretanto, thalac aparentemente possui uma padrão linear com o logit, mas esse padrão é deformado por causa da observação 96 .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modelo excluindo o paciente 96</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Usamos o row.names para garantir que estamos tirando o ponto certo identificado no gráfico</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>treino_off <span class="ot">&lt;-</span> treino[<span class="fu">row.names</span>(treino) <span class="sc">!=</span> <span class="st">"9modelo_reduzido_6"</span>, ]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>modelo_off <span class="ot">&lt;-</span> <span class="fu">glm</span>(condition <span class="sc">~</span> thalach <span class="sc">+</span> sex <span class="sc">+</span> cp <span class="sc">+</span> oldpeak <span class="sc">+</span> slope <span class="sc">+</span> ca <span class="sc">+</span> thal, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> treino_off, <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>coef_on <span class="ot">&lt;-</span> <span class="fu">coef</span>(modelo1_)[<span class="st">"thalach"</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>coef_off <span class="ot">&lt;-</span> <span class="fu">coef</span>(modelo_off)[<span class="st">"thalach"</span>]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>variacao <span class="ot">&lt;-</span> ((coef_off <span class="sc">-</span> coef_on) <span class="sc">/</span> coef_on) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Coeficiente ON:"</span>, coef_on, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coeficiente ON: -0.01151674 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Coeficiente OFF:"</span>, coef_off, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coeficiente OFF: -0.007375631 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Variação Percentual:"</span>, variacao, <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variação Percentual: -35.95731 %</code></pre>
</div>
</div>
</section>
<section id="analisando-os-coeficientes-do-modelo-reduzido" class="level2">
<h2 class="anchored" data-anchor-id="analisando-os-coeficientes-do-modelo-reduzido">Analisando os coeficientes do modelo reduzido</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo_reduzido_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = condition ~ sex + cp + oldpeak + slope + ca + thal, 
    family = "binomial", data = treino)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  -5.9413     1.0866  -5.468 4.55e-08 ***
sex1          1.5013     0.5701   2.633 0.008457 ** 
cp1           1.9084     0.8790   2.171 0.029920 *  
cp2           0.1321     0.8094   0.163 0.870380    
cp3           2.8874     0.7625   3.787 0.000153 ***
oldpeak       0.7464     0.2675   2.790 0.005265 ** 
slope1        1.4200     0.5586   2.542 0.011027 *  
slope2        0.3778     0.9772   0.387 0.699022    
ca1           2.4781     0.5834   4.248 2.16e-05 ***
ca2           2.7872     0.7884   3.535 0.000407 ***
ca3           3.0723     1.1399   2.695 0.007031 ** 
thal1        -0.4301     0.9152  -0.470 0.638360    
thal2         1.6062     0.4905   3.275 0.001058 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 328.58  on 237  degrees of freedom
Residual deviance: 145.99  on 225  degrees of freedom
AIC: 171.99

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<p>O AIC do modelo reduzido (171.99) foi menor que o do modelo completo, e a Deviance Residual foi aproximadamente igual. Ou seja, o modelo com menos variáveis conseguiu explicar tão bem os dados quanto o completo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcula os Odds Ratios e os Intervalos de Confiança</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>intervalos <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">confint</span>(modelo_reduzido_))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Waiting for profiling to be done...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ors <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">coef</span>(modelo_reduzido_))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cria o data frame e calcula a Amplitude</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>tabela_coef <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">OR =</span> ors,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2.5"</span> <span class="ot">=</span> intervalos[,<span class="dv">1</span>],</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"97.5"</span> <span class="ot">=</span> intervalos[,<span class="dv">2</span>],</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Amplitude =</span> intervalos[,<span class="dv">2</span>] <span class="sc">-</span> intervalos[,<span class="dv">1</span>] <span class="co"># Diferença absoluta</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="fu">pander</span>(tabela_coef, </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Odds Ratios, Intervalos de Confiança e Amplitude"</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Odds Ratios, Intervalos de Confiança e Amplitude</caption>
<colgroup>
<col style="width: 25%">
<col style="width: 15%">
<col style="width: 16%">
<col style="width: 13%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">OR</th>
<th style="text-align: center;">X2.5</th>
<th style="text-align: center;">X97.5</th>
<th style="text-align: center;">Amplitude</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>(Intercept)</strong></td>
<td style="text-align: center;">0.002629</td>
<td style="text-align: center;">0.0002555</td>
<td style="text-align: center;">0.01868</td>
<td style="text-align: center;">0.01842</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>sex1</strong></td>
<td style="text-align: center;">4.487</td>
<td style="text-align: center;">1.524</td>
<td style="text-align: center;">14.54</td>
<td style="text-align: center;">13.02</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>cp1</strong></td>
<td style="text-align: center;">6.742</td>
<td style="text-align: center;">1.257</td>
<td style="text-align: center;">40.86</td>
<td style="text-align: center;">39.6</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>cp2</strong></td>
<td style="text-align: center;">1.141</td>
<td style="text-align: center;">0.2326</td>
<td style="text-align: center;">5.755</td>
<td style="text-align: center;">5.522</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>cp3</strong></td>
<td style="text-align: center;">17.95</td>
<td style="text-align: center;">4.36</td>
<td style="text-align: center;">89.08</td>
<td style="text-align: center;">84.72</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>oldpeak</strong></td>
<td style="text-align: center;">2.109</td>
<td style="text-align: center;">1.278</td>
<td style="text-align: center;">3.68</td>
<td style="text-align: center;">2.401</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>slope1</strong></td>
<td style="text-align: center;">4.137</td>
<td style="text-align: center;">1.427</td>
<td style="text-align: center;">12.99</td>
<td style="text-align: center;">11.56</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>slope2</strong></td>
<td style="text-align: center;">1.459</td>
<td style="text-align: center;">0.2034</td>
<td style="text-align: center;">9.701</td>
<td style="text-align: center;">9.497</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>ca1</strong></td>
<td style="text-align: center;">11.92</td>
<td style="text-align: center;">3.986</td>
<td style="text-align: center;">39.93</td>
<td style="text-align: center;">35.94</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>ca2</strong></td>
<td style="text-align: center;">16.24</td>
<td style="text-align: center;">3.77</td>
<td style="text-align: center;">83.96</td>
<td style="text-align: center;">80.19</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>ca3</strong></td>
<td style="text-align: center;">21.59</td>
<td style="text-align: center;">2.872</td>
<td style="text-align: center;">261.3</td>
<td style="text-align: center;">258.5</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>thal1</strong></td>
<td style="text-align: center;">0.6504</td>
<td style="text-align: center;">0.1084</td>
<td style="text-align: center;">4.116</td>
<td style="text-align: center;">4.008</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>thal2</strong></td>
<td style="text-align: center;">4.984</td>
<td style="text-align: center;">1.94</td>
<td style="text-align: center;">13.45</td>
<td style="text-align: center;">11.51</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>É possível observar que alguns coeficientes estimados são muito incertos (o modelo não conseguiu definir se a associação entre a respectiva variável e o target era positiva ou negativa);</p>
<p>Essas variáveis foram : cp2, slope2 e thal1</p>
<p>Outros coeficientes tinham IC com amplitude grande demais, como foi o caso de cp3, ca3, ca2</p>
<p>Ou seja, o modelo não conseguiu estimar precisamente esses coeficientes</p>
<p>Uma possível motivação para isso é que essas variáveis categóricas possuem algumas classes subrepresentadas no dataset, dificultando a estimação dos parâmetros.</p>
<section id="verificando-se-há-linearidade-no-logito-para-a-varti-oldpeak" class="level3">
<h3 class="anchored" data-anchor-id="verificando-se-há-linearidade-no-logito-para-a-varti-oldpeak">Verificando se há linearidade no logito para a varti oldpeak</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_logit_linearity</span>(modelo_reduzido_, <span class="st">"oldpeak"</span>, treino)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="relatorio_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="treinando-modelo-com-agrupamento-de-classes-subrepresentadas" class="level2">
<h2 class="anchored" data-anchor-id="treinando-modelo-com-agrupamento-de-classes-subrepresentadas">Treinando modelo com agrupamento de classes subrepresentadas</h2>
<ul>
<li>cp :
<ul>
<li>com_dor : {0, 1, 2}</li>
<li>sem_dor : {3}</li>
</ul></li>
<li>slope :
<ul>
<li>asc : {0}</li>
<li>not_asc : {1, 2}</li>
</ul></li>
<li>ca :
<ul>
<li>zero : {0}</li>
<li>not_zero : {1, 2, 3}</li>
</ul></li>
<li>thal :
<ul>
<li>normal : {0}</li>
<li>not_normal : {1, 2}</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>modelo_agrupado <span class="ot">&lt;-</span> <span class="fu">glm</span>(condition <span class="sc">~</span> sex<span class="sc">+</span> cp <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                   oldpeak <span class="sc">+</span> slope <span class="sc">+</span> ca <span class="sc">+</span> thal, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> treino_agrupado, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">family =</span> <span class="st">"binomial"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelo_agrupado)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = condition ~ sex + cp + oldpeak + slope + ca + thal, 
    family = "binomial", data = treino_agrupado)

Coefficients:
                Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)      -2.1741     0.5627  -3.864 0.000112 ***
sex1              1.1387     0.4984   2.285 0.022342 *  
cp_sem dor        2.1247     0.4299   4.943 7.70e-07 ***
oldpeak           0.5708     0.2290   2.493 0.012669 *  
slope_not_asc     0.9416     0.4819   1.954 0.050691 .  
ca_zero          -2.3326     0.4465  -5.224 1.75e-07 ***
thal_not_normal   1.2461     0.4543   2.743 0.006092 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 328.58  on 237  degrees of freedom
Residual deviance: 157.70  on 231  degrees of freedom
AIC: 171.7

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcula os Odds Ratios e os Intervalos de Confiança</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>intervalos <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">confint</span>(modelo_agrupado))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Waiting for profiling to be done...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ors <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">coef</span>(modelo_agrupado))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cria o data frame e calcula a Amplitude</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>tabela_coef <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">OR =</span> ors,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"2.5"</span> <span class="ot">=</span> intervalos[,<span class="dv">1</span>],</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"97.5"</span> <span class="ot">=</span> intervalos[,<span class="dv">2</span>],</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Amplitude =</span> intervalos[,<span class="dv">2</span>] <span class="sc">-</span> intervalos[,<span class="dv">1</span>] <span class="co"># Diferença absoluta</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="fu">pander</span>(tabela_coef, </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Odds Ratios, Intervalos de Confiança e Amplitude"</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Odds Ratios, Intervalos de Confiança e Amplitude</caption>
<colgroup>
<col style="width: 30%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">&nbsp;</th>
<th style="text-align: center;">OR</th>
<th style="text-align: center;">X2.5</th>
<th style="text-align: center;">X97.5</th>
<th style="text-align: center;">Amplitude</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>(Intercept)</strong></td>
<td style="text-align: center;">0.1137</td>
<td style="text-align: center;">0.0346</td>
<td style="text-align: center;">0.3199</td>
<td style="text-align: center;">0.2853</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>sex1</strong></td>
<td style="text-align: center;">3.123</td>
<td style="text-align: center;">1.196</td>
<td style="text-align: center;">8.564</td>
<td style="text-align: center;">7.368</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>cp_sem dor</strong></td>
<td style="text-align: center;">8.37</td>
<td style="text-align: center;">3.71</td>
<td style="text-align: center;">20.25</td>
<td style="text-align: center;">16.54</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>oldpeak</strong></td>
<td style="text-align: center;">1.77</td>
<td style="text-align: center;">1.15</td>
<td style="text-align: center;">2.836</td>
<td style="text-align: center;">1.686</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>slope_not_asc</strong></td>
<td style="text-align: center;">2.564</td>
<td style="text-align: center;">1.004</td>
<td style="text-align: center;">6.721</td>
<td style="text-align: center;">5.717</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>ca_zero</strong></td>
<td style="text-align: center;">0.09704</td>
<td style="text-align: center;">0.03845</td>
<td style="text-align: center;">0.2243</td>
<td style="text-align: center;">0.1859</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>thal_not_normal</strong></td>
<td style="text-align: center;">3.477</td>
<td style="text-align: center;">1.439</td>
<td style="text-align: center;">8.636</td>
<td style="text-align: center;">7.198</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Aqui, é possível observar que os parâmetros estão mais estáveis e os odds ratios estão mais de acordo com os insights obtidos na EDA;</p>
</section>
</section>
<section id="criando-árvore-de-decisão-de-acordo-com-as-variáveis-usadas-no-modelo-logístico-reduzido" class="level1">
<h1>Criando árvore de decisão de acordo com as variáveis usadas no modelo logístico reduzido</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Árvore de Decisão nos Dados Originais</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>arvore_original <span class="ot">&lt;-</span> <span class="fu">rpart</span>(condition <span class="sc">~</span> sex <span class="sc">+</span> cp <span class="sc">+</span> oldpeak <span class="sc">+</span> slope <span class="sc">+</span> ca <span class="sc">+</span> thal, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> treino, </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Árvore de Decisão nos Dados com classes agrupadas </span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>arvore_limpa <span class="ot">&lt;-</span> <span class="fu">rpart</span>(condition <span class="sc">~</span> sex <span class="sc">+</span> cp <span class="sc">+</span> oldpeak <span class="sc">+</span> slope <span class="sc">+</span> ca <span class="sc">+</span> thal, </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> treino_limpo, </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotando das árvores</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(arvore_original, <span class="at">main =</span> <span class="st">"Árvore: Dados Originais"</span>, </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">104</span>, <span class="at">under =</span> <span class="cn">TRUE</span>, <span class="at">faclen =</span> <span class="dv">0</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(arvore_limpa, <span class="at">main =</span> <span class="st">"Árvore: Dados com classes agrupadas"</span>, </span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="dv">4</span>, <span class="at">extra =</span> <span class="dv">104</span>, <span class="at">under =</span> <span class="cn">TRUE</span>, <span class="at">faclen =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="relatorio_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As duas árvores geradas são iguais, isso mostra que o agrupamento das classes subrepresentadas faz sentido;</p>
<!-- 
## Verificando o desempenho do modelo no conjunto de teste (via boostrap)

::: {.cell}

```{.r .cell-code}
# BOOTSTRAP
set.seed(123)
n_boot <- 1000

# Bootstrap para os 3 modelos principais
boot_reduzido <- boot(data = teste, statistic = calc_boot_metrics, 
                      R = n_boot, modelo = modelo_reduzido_, tipo_modelo = "glm")

boot_agrupado <- boot(data = teste_agrupado, statistic = calc_boot_metrics, 
                      R = n_boot, modelo = modelo_agrupado, tipo_modelo = "glm")

boot_arvore   <- boot(data = teste_agrupado, statistic = calc_boot_metrics, 
                      R = n_boot, modelo = arvore_limpa, tipo_modelo = "tree")


tabela_bootstrap <- rbind(
  summarize_boot(boot_reduzido, "Logística Reduzida"),
  summarize_boot(boot_agrupado, "Logística Agrupada"),
  summarize_boot(boot_arvore, "Árvore de Decisão")
)


tabela_ordenada <- tabela_bootstrap %>%
  arrange(Metrica, desc(Modelo))

pander(tabela_ordenada, 
       caption = "Métricas de Performance Ordenadas (Média e IC de 95%)",
       split.table = Inf, # Evita que a tabela quebre em colunas
       digits = 4)
```

::: {.cell-output-display}

--------------------------------------------------------------
       Modelo         Metrica    Media    IC_Lower   IC_Upper 
-------------------- ---------- -------- ---------- ----------
 Árvore de Decisão      AUC      0.8279    0.7137     0.9306  

 Logística Reduzida     AUC      0.8683    0.7564     0.9628  

 Logística Agrupada     AUC      0.8836    0.775      0.9674  

 Árvore de Decisão    Acurácia   0.8309    0.7288     0.9153  

 Logística Reduzida   Acurácia   0.8112    0.7119     0.8983  

 Logística Agrupada   Acurácia   0.7972    0.6949     0.8983  

 Árvore de Decisão     PR-AUC    0.3507    0.2024     0.5061  

 Logística Reduzida    PR-AUC    0.8313    0.7126     0.9267  

 Logística Agrupada    PR-AUC    0.8415    0.7232     0.9297  

 Árvore de Decisão    Precisão   0.8234    0.6875     0.9429  

 Logística Reduzida   Precisão   0.8137    0.6748     0.9355  

 Logística Agrupada   Precisão   0.8136    0.6762     0.9376  

 Árvore de Decisão     Recall    0.8756     0.75      0.9722  

 Logística Reduzida    Recall    0.8432    0.7097     0.9584  

 Logística Agrupada    Recall    0.8131    0.6667     0.9375  
--------------------------------------------------------------

Table: Métricas de Performance Ordenadas (Média e IC de 95%)


:::
:::




::: {.cell}

```{.r .cell-code}
ggplot(tabela_ordenada, aes(x = Modelo, y = Media, color = Modelo)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = IC_Lower, ymax = IC_Upper), width = 0.2, linewidth = 1) +
  facet_wrap(~Metrica, scales = "free_y") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  labs(
    title = "Comparação de Modelos via Bootstrap (n=59 no teste)",
    subtitle = "Pontos representam a média e barras representam o IC de 95%",
    y = "Valor da Métrica",
    x = ""
  ) +
  theme(
    axis.text.x = element_blank(), # Remove o texto do eixo X para não sobrepor
    strip.text = element_text(face = "bold", size = 10), # Estiliza o título dos quadros
    legend.position = "bottom"
  )
```

::: {.cell-output-display}
![](relatorio_files/figure-html/unnamed-chunk-20-1.png){width=672}
:::
:::


Esse gráfico mostra que o desempenho dos modelos parece ser equivalente entre os modelos, entretando, no PR-AUC, é possível observar que a árvore de decisão teve um valor muito inferior aos outros, ou seja, ela é um modelo muito sensível a pequenas mudanças.


### Teste de hipótese de diferença de médias entre o modelo logístico nos dados agrupados e a árvore de decisão


::: {.cell}

```{.r .cell-code}
metricas_nomes <- c("Acurácia", "Precisão", "Recall", "AUC", "PR-AUC")
resultados_testes <- data.frame()

# --- 2. LOOP PARA CÁLCULO DE P-VALOR POR MÉTRICA ---
for (i in 1:5) {
  dist_agrupada <- boot_agrupado$t[, i]
  dist_arvore   <- boot_arvore$t[, i]
  
  # Diferença das distribuições (Agrupada - Árvore)
  diff_dist <- dist_agrupada - dist_arvore
  
  # P-valor: proporção de vezes que a árvore empatou ou venceu
  p_val <- mean(diff_dist <= 0)
  
  # Armazenando resultados
  resultados_testes <- rbind(resultados_testes, data.frame(
    Métrica = metricas_nomes[i],
    Diferença_Média = mean(diff_dist),
    P_Valor = p_val,
    Significativo_05 = ifelse(p_val < 0.05, "Sim", "Não")
  ))
}

# --- 3. EXIBIÇÃO DA TABELA ---
pander(resultados_testes, 
       caption = "Teste de Hipótese via Bootstrap: Logística Agrupada vs. Árvore de Decisão",
       digits = 4)
```

::: {.cell-output-display}

---------------------------------------------------------
 Métrica    Diferença_Média   P_Valor   Significativo_05 
---------- ----------------- --------- ------------------
 Acurácia      -0.03378        0.717          Não        

 Precisão      -0.009789       0.54           Não        

  Recall       -0.06255        0.759          Não        

   AUC          0.0557         0.22           Não        

  PR-AUC        0.4908           0            Sim        
---------------------------------------------------------

Table: Teste de Hipótese via Bootstrap: Logística Agrupada vs. Árvore de Decisão


:::
:::


### Teste de hipótese de diferença de médias entre o modelo logístico nos dados agrupados e nos dados originais

::: {.cell}

```{.r .cell-code}
metricas_nomes <- c("Acurácia", "Precisão", "Recall", "AUC", "PR-AUC")
resultados_testes <- data.frame()

# --- 2. LOOP PARA CÁLCULO DE P-VALOR POR MÉTRICA ---
for (i in 1:5) {
  dist_agrupada <- boot_agrupado$t[, i]
  dist_reduzido   <- boot_reduzido$t[, i]
  
  # Diferença das distribuições (Agrupada - Árvore)
  diff_dist <- dist_agrupada - dist_reduzido
  
  # P-valor: proporção de vezes que a árvore empatou ou venceu
  p_val <- mean(diff_dist <= 0)
  
  # Armazenando resultados
  resultados_testes <- rbind(resultados_testes, data.frame(
    Métrica = metricas_nomes[i],
    Diferença_Média = mean(diff_dist),
    P_Valor = p_val,
    Significativo_05 = ifelse(p_val < 0.05, "Sim", "Não")
  ))
}

# --- 3. EXIBIÇÃO DA TABELA ---
pander(resultados_testes, 
       caption = "Teste de Hipótese via Bootstrap: Logística Agrupada vs. Árvore de Decisão",
       digits = 4)
```

::: {.cell-output-display}

---------------------------------------------------------
 Métrica    Diferença_Média   P_Valor   Significativo_05 
---------- ----------------- --------- ------------------
 Acurácia       -0.014         0.615          Não        

 Precisão     -0.0001247       0.508          Não        

  Recall       -0.03017        0.638          Não        

   AUC          0.01536        0.417          Não        

  PR-AUC        0.01019        0.435          Não        
---------------------------------------------------------

Table: Teste de Hipótese via Bootstrap: Logística Agrupada vs. Árvore de Decisão


:::
:::



# Conclusão


Como não há diferenças significativas entre o desempenho do modelo logístico com e sem os dados agrupados e o modelo com classes agrupadas teve parâmetros mais "comportados", o escolheremos como o melhor modelo, nessa análise. -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>